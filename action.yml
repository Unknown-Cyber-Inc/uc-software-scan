name: 'NPM Binary Scanner'
description: 'Scans npm packages for binary executables and optionally uploads them to UnknownCyber for analysis'
author: 'UnknownCyber'

branding:
  icon: 'search'
  color: 'blue'

inputs:
  scan-path:
    description: 'Path to the directory containing node_modules to scan'
    required: false
    default: '.'
  deep-scan:
    description: 'Enable deep scan using magic bytes detection (slower but more thorough)'
    required: false
    default: 'false'
  upload:
    description: 'Upload found binaries to UnknownCyber API'
    required: false
    default: 'false'
  skip-existing:
    description: 'Skip uploading files that already exist in UnknownCyber (default: true)'
    required: false
    default: 'true'
  get-reputations:
    description: 'Fetch reputation data for existing files (default: true)'
    required: false
    default: 'true'
  api-url:
    description: 'UnknownCyber API URL'
    required: false
    default: 'https://api.unknowncyber.com'
  api-key:
    description: 'UnknownCyber API key for authentication'
    required: false
    default: ''
  repo:
    description: 'Repository name to tag uploads with (defaults to current GitHub repository)'
    required: false
    default: '${{ github.repository }}'
  yara-scan:
    description: 'Enable YARA scanning'
    required: false
    default: 'false'
  yara-rules:
    description: 'Path to additional YARA rules file or directory'
    required: false
    default: ''
  yara-include:
    description: 'File patterns to scan with YARA (e.g., "*.js,*.html"). If empty, scans binaries from results.'
    required: false
    default: ''

outputs:
  total-packages:
    description: 'Number of packages containing binaries'
  total-binaries:
    description: 'Total number of binary files found'
  results-file:
    description: 'Path to the JSON results file'
  upload-successful:
    description: 'Number of successfully uploaded files'
  upload-failed:
    description: 'Number of failed uploads'
  upload-skipped:
    description: 'Number of files skipped (already exist in UC)'
  threats-found:
    description: 'Number of files with HIGH or MEDIUM threat level'
  yara-matches:
    description: 'Number of files with YARA rule matches'
  yara-high-severity:
    description: 'Number of files with high/critical severity YARA matches'

runs:
  using: 'composite'
  steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Run Binary Scanner
      id: scan
      shell: bash
      env:
        SCAN_PATH: ${{ inputs.scan-path }}
        DEEP_SCAN: ${{ inputs.deep-scan }}
        UPLOAD: ${{ inputs.upload }}
        SKIP_EXISTING: ${{ inputs.skip-existing }}
        GET_REPUTATIONS: ${{ inputs.get-reputations }}
        UC_API_URL: ${{ inputs.api-url }}
        UC_API_KEY: ${{ inputs.api-key }}
        UC_REPO: ${{ inputs.repo }}
      run: |
        # Build command arguments
        ARGS=""
        if [ "$DEEP_SCAN" = "true" ]; then
          ARGS="$ARGS --deep"
        fi
        if [ "$UPLOAD" = "true" ]; then
          ARGS="$ARGS --upload"
        fi
        if [ "$SKIP_EXISTING" = "false" ]; then
          ARGS="$ARGS --force-upload"
        fi
        if [ "$GET_REPUTATIONS" = "false" ]; then
          ARGS="$ARGS --no-reputations"
        fi
        if [ -n "$UC_REPO" ]; then
          ARGS="$ARGS --repo $UC_REPO"
        fi
        
        # Run the scanner
        node "${{ github.action_path }}/scanner.js" $ARGS "$SCAN_PATH"
        
        # Parse results from JSON
        if [ -f "$SCAN_PATH/binary-scan-results.json" ]; then
          TOTAL_PACKAGES=$(node -e "console.log(require('./$SCAN_PATH/binary-scan-results.json').totalPackages)")
          TOTAL_BINARIES=$(node -e "console.log(require('./$SCAN_PATH/binary-scan-results.json').totalBinaries)")
          
          echo "total-packages=$TOTAL_PACKAGES" >> $GITHUB_OUTPUT
          echo "total-binaries=$TOTAL_BINARIES" >> $GITHUB_OUTPUT
          echo "results-file=$SCAN_PATH/binary-scan-results.json" >> $GITHUB_OUTPUT
          
          # Check for upload results
          UPLOAD_SUCCESS=$(node -e "const r = require('./$SCAN_PATH/binary-scan-results.json'); console.log(r.uploadResults?.successful?.length || 0)")
          UPLOAD_FAILED=$(node -e "const r = require('./$SCAN_PATH/binary-scan-results.json'); console.log(r.uploadResults?.failed?.length || 0)")
          UPLOAD_SKIPPED=$(node -e "const r = require('./$SCAN_PATH/binary-scan-results.json'); console.log(r.uploadResults?.skipped?.length || 0)")
          THREATS_FOUND=$(node -e "const r = require('./$SCAN_PATH/binary-scan-results.json'); const reps = r.uploadResults?.reputations || []; console.log(reps.filter(x => x.reputation && ['high','medium'].includes(x.reputation.overallThreatLevel)).length)")
          
          echo "upload-successful=$UPLOAD_SUCCESS" >> $GITHUB_OUTPUT
          echo "upload-failed=$UPLOAD_FAILED" >> $GITHUB_OUTPUT
          echo "upload-skipped=$UPLOAD_SKIPPED" >> $GITHUB_OUTPUT
          echo "threats-found=$THREATS_FOUND" >> $GITHUB_OUTPUT
        fi

    - name: Setup Python for YARA
      if: inputs.yara-scan == 'true'
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install YARA Python
      if: inputs.yara-scan == 'true'
      shell: bash
      run: pip install yara-python>=4.3.0

    - name: Run YARA Scanner
      id: yara
      if: inputs.yara-scan == 'true'
      shell: bash
      env:
        SCAN_PATH: ${{ inputs.scan-path }}
        YARA_RULES: ${{ inputs.yara-rules }}
        YARA_INCLUDE: ${{ inputs.yara-include }}
      run: |
        # Build YARA command arguments
        YARA_ARGS="--output $SCAN_PATH/yara-results.json"
        YARA_ARGS="$YARA_ARGS --github-annotations"
        
        # If include patterns provided, scan files directly; otherwise scan binaries from results
        if [ -n "$YARA_INCLUDE" ]; then
          YARA_ARGS="$YARA_ARGS --dir $SCAN_PATH/node_modules"
          # Split comma-separated patterns and add each as --include
          IFS=',' read -ra PATTERNS <<< "$YARA_INCLUDE"
          for pattern in "${PATTERNS[@]}"; do
            YARA_ARGS="$YARA_ARGS --include \"$pattern\""
          done
        else
          YARA_ARGS="$YARA_ARGS --input $SCAN_PATH/binary-scan-results.json"
        fi
        
        # Add user-provided rules if specified
        if [ -n "$YARA_RULES" ]; then
          YARA_ARGS="$YARA_ARGS --rules $YARA_RULES"
        fi
        
        # Run YARA scanner
        eval python "${{ github.action_path }}/yara_scanner.py" $YARA_ARGS
        
        # Parse YARA results
        if [ -f "$SCAN_PATH/yara-results.json" ]; then
          YARA_MATCHES=$(node -e "console.log(require('./$SCAN_PATH/yara-results.json').filesWithMatches || 0)")
          YARA_HIGH=$(node -e "const r = require('./$SCAN_PATH/yara-results.json'); const matches = r.results || []; let count = 0; matches.forEach(m => m.matches.forEach(x => { if(['critical','high'].includes(x.meta?.severity)) count++; })); console.log(count)")
          
          echo "yara-matches=$YARA_MATCHES" >> $GITHUB_OUTPUT
          echo "yara-high-severity=$YARA_HIGH" >> $GITHUB_OUTPUT
        else
          echo "yara-matches=0" >> $GITHUB_OUTPUT
          echo "yara-high-severity=0" >> $GITHUB_OUTPUT
        fi

    - name: Upload Results Artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: binary-scan-results
        path: |
          ${{ inputs.scan-path }}/binary-scan-results.json
          ${{ inputs.scan-path }}/yara-results.json
        retention-days: 30
        overwrite: true

