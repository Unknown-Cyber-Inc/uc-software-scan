name: 'Package Binary Scanner'
description: 'Scans package directories for binary executables and optionally uploads them to UnknownCyber for analysis. Auto-detects npm, pip, maven, cargo, go, and ruby ecosystems from installed packages.'
author: 'UnknownCyber'

branding:
  icon: 'search'
  color: 'blue'

inputs:
  scan-path:
    description: 'Path to the directory to scan'
    required: false
    default: '.'
  ecosystems:
    description: 'Comma-separated list of ecosystems to scan (npm, pip, maven, cargo, go, ruby, generic). Default: auto-detect from installed packages.'
    required: false
    default: ''
  deep-scan:
    description: 'Enable deep scan using magic bytes detection (slower but more thorough)'
    required: false
    default: 'false'
  upload:
    description: 'Upload found binaries to UnknownCyber API'
    required: false
    default: 'false'
  skip-existing:
    description: 'Skip uploading files that already exist in UnknownCyber (default: true)'
    required: false
    default: 'true'
  get-reputations:
    description: 'Fetch reputation data for existing files (default: true)'
    required: false
    default: 'true'
  include-package-json:
    description: 'Include package.json files for SBOM creation'
    required: false
    default: 'false'
  include-all-files:
    description: 'Include ALL files in package directories (not just executables)'
    required: false
    default: 'false'
  api-url:
    description: 'UnknownCyber API URL'
    required: false
    default: 'https://api.unknowncyber.com'
  api-key:
    description: 'UnknownCyber API key for authentication'
    required: false
    default: ''
  repo:
    description: 'Repository name to tag uploads with (defaults to current GitHub repository)'
    required: false
    default: '${{ github.repository }}'
  yara-scan:
    description: 'Enable YARA scanning'
    required: false
    default: 'false'
  yara-rules:
    description: 'Path to additional YARA rules file or directory'
    required: false
    default: ''
  yara-include:
    description: 'File patterns to scan with YARA (e.g., "*.js,*.html"). If empty, scans binaries from results.'
    required: false
    default: ''
  generate-summary:
    description: 'Generate a summary report in GitHub Actions UI with links to UC reports'
    required: false
    default: 'false'
  fail-on-threats:
    description: 'Fail the action if HIGH/MEDIUM threats or high-severity YARA matches are found'
    required: false
    default: 'false'
  license-check:
    description: 'Enable license compliance checking (npm only)'
    required: false
    default: 'false'
  license-policy:
    description: 'License policy file path or preset (permissive, strict, copyleft-ok)'
    required: false
    default: 'permissive'
  fail-on-license:
    description: 'Fail the action if denied licenses are found'
    required: false
    default: 'false'

outputs:
  total-packages:
    description: 'Number of packages containing binaries'
    value: ${{ steps.scan.outputs.total-packages }}
  total-binaries:
    description: 'Total number of binary files found'
    value: ${{ steps.scan.outputs.total-binaries }}
  results-file:
    description: 'Path to the JSON results file'
    value: ${{ steps.scan.outputs.results-file }}
  upload-successful:
    description: 'Number of successfully uploaded files'
    value: ${{ steps.scan.outputs.upload-successful }}
  upload-failed:
    description: 'Number of failed uploads'
    value: ${{ steps.scan.outputs.upload-failed }}
  upload-skipped:
    description: 'Number of files skipped (already exist in UC)'
    value: ${{ steps.scan.outputs.upload-skipped }}
  threats-found:
    description: 'Number of files with HIGH or MEDIUM threat level'
    value: ${{ steps.scan.outputs.threats-found }}
  ecosystems-scanned:
    description: 'List of ecosystems that were scanned'
    value: ${{ steps.scan.outputs.ecosystems-scanned }}
  yara-matches:
    description: 'Number of files with YARA rule matches'
    value: ${{ steps.yara.outputs.yara-matches }}
  yara-high-severity:
    description: 'Number of files with high/critical severity YARA matches'
    value: ${{ steps.yara.outputs.yara-high-severity }}
  license-allowed:
    description: 'Number of packages with allowed licenses'
    value: ${{ steps.license.outputs.license-allowed }}
  license-warning:
    description: 'Number of packages with licenses needing review'
    value: ${{ steps.license.outputs.license-warning }}
  license-denied:
    description: 'Number of packages with denied licenses'
    value: ${{ steps.license.outputs.license-denied }}

runs:
  using: 'composite'
  steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Run Binary Scanner
      id: scan
      shell: bash
      env:
        SCAN_PATH: ${{ inputs.scan-path }}
        ECOSYSTEMS: ${{ inputs.ecosystems }}
        DEEP_SCAN: ${{ inputs.deep-scan }}
        UPLOAD: ${{ inputs.upload }}
        SKIP_EXISTING: ${{ inputs.skip-existing }}
        GET_REPUTATIONS: ${{ inputs.get-reputations }}
        INCLUDE_PACKAGE_JSON: ${{ inputs.include-package-json }}
        INCLUDE_ALL_FILES: ${{ inputs.include-all-files }}
        UC_API_URL: ${{ inputs.api-url }}
        UC_API_KEY: ${{ inputs.api-key }}
        UC_REPO: ${{ inputs.repo }}
      run: |
        ARGS=""
        if [ -n "$ECOSYSTEMS" ]; then
          ARGS="$ARGS --ecosystem $ECOSYSTEMS"
        fi
        if [ "$DEEP_SCAN" = "true" ]; then
          ARGS="$ARGS --deep"
        fi
        if [ "$UPLOAD" = "true" ]; then
          ARGS="$ARGS --upload"
        fi
        if [ "$SKIP_EXISTING" = "false" ]; then
          ARGS="$ARGS --force-upload"
        fi
        if [ "$GET_REPUTATIONS" = "false" ]; then
          ARGS="$ARGS --no-reputations"
        fi
        if [ "$INCLUDE_PACKAGE_JSON" = "true" ]; then
          ARGS="$ARGS --include-package-json"
        fi
        if [ "$INCLUDE_ALL_FILES" = "true" ]; then
          ARGS="$ARGS --all-files"
        fi
        if [ -n "$UC_REPO" ]; then
          ARGS="$ARGS --repo $UC_REPO"
        fi
        
        node "${{ github.action_path }}/scanner.js" $ARGS "$SCAN_PATH"
        
        if [ -f "$SCAN_PATH/binary-scan-results.json" ]; then
          TOTAL_PACKAGES=$(node -e "console.log(require('./$SCAN_PATH/binary-scan-results.json').totalPackages)")
          TOTAL_BINARIES=$(node -e "console.log(require('./$SCAN_PATH/binary-scan-results.json').totalBinaries || require('./$SCAN_PATH/binary-scan-results.json').totalFiles)")
          ECOSYSTEMS_SCANNED=$(node -e "console.log((require('./$SCAN_PATH/binary-scan-results.json').ecosystems || ['npm']).join(','))")
          
          echo "total-packages=$TOTAL_PACKAGES" >> $GITHUB_OUTPUT
          echo "total-binaries=$TOTAL_BINARIES" >> $GITHUB_OUTPUT
          echo "ecosystems-scanned=$ECOSYSTEMS_SCANNED" >> $GITHUB_OUTPUT
          echo "results-file=$SCAN_PATH/binary-scan-results.json" >> $GITHUB_OUTPUT
          
          UPLOAD_SUCCESS=$(node -e "const r = require('./$SCAN_PATH/binary-scan-results.json'); console.log(r.uploadResults?.successful?.length || 0)")
          UPLOAD_FAILED=$(node -e "const r = require('./$SCAN_PATH/binary-scan-results.json'); console.log(r.uploadResults?.failed?.length || 0)")
          UPLOAD_SKIPPED=$(node -e "const r = require('./$SCAN_PATH/binary-scan-results.json'); console.log(r.uploadResults?.skipped?.length || 0)")
          THREATS_FOUND=$(node -e "const r = require('./$SCAN_PATH/binary-scan-results.json'); const reps = r.uploadResults?.reputations || []; console.log(reps.filter(x => x.reputation && ['high','medium'].includes(x.reputation.overallThreatLevel)).length)")
          
          echo "upload-successful=$UPLOAD_SUCCESS" >> $GITHUB_OUTPUT
          echo "upload-failed=$UPLOAD_FAILED" >> $GITHUB_OUTPUT
          echo "upload-skipped=$UPLOAD_SKIPPED" >> $GITHUB_OUTPUT
          echo "threats-found=$THREATS_FOUND" >> $GITHUB_OUTPUT
        fi

    - name: Setup Python for YARA
      if: ${{ inputs.yara-scan == 'true' }}
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install YARA Python
      if: ${{ inputs.yara-scan == 'true' }}
      shell: bash
      run: pip install yara-python>=4.3.0

    - name: Run YARA Scanner
      id: yara
      if: ${{ inputs.yara-scan == 'true' }}
      shell: bash
      env:
        SCAN_PATH: ${{ inputs.scan-path }}
        YARA_RULES: ${{ inputs.yara-rules }}
        YARA_INCLUDE: ${{ inputs.yara-include }}
      run: |
        YARA_ARGS="--output $SCAN_PATH/yara-results.json --github-annotations"
        
        if [ -n "$YARA_INCLUDE" ]; then
          # Use the scan path directly for YARA include patterns
          YARA_ARGS="$YARA_ARGS --dir $SCAN_PATH"
          IFS=',' read -ra PATTERNS <<< "$YARA_INCLUDE"
          for pattern in "${PATTERNS[@]}"; do
            YARA_ARGS="$YARA_ARGS --include \"$pattern\""
          done
        else
          YARA_ARGS="$YARA_ARGS --input $SCAN_PATH/binary-scan-results.json"
        fi
        
        if [ -n "$YARA_RULES" ]; then
          YARA_ARGS="$YARA_ARGS --rules $YARA_RULES"
        fi
        
        eval python "${{ github.action_path }}/yara_scanner.py" $YARA_ARGS
        
        if [ -f "$SCAN_PATH/yara-results.json" ]; then
          YARA_MATCHES=$(node -e "console.log(require('./$SCAN_PATH/yara-results.json').filesWithMatches || 0)")
          YARA_HIGH=$(node -e "const r = require('./$SCAN_PATH/yara-results.json'); const matches = r.results || []; let count = 0; matches.forEach(m => m.matches.forEach(x => { if(['critical','high'].includes(x.meta?.severity)) count++; })); console.log(count)")
          echo "yara-matches=$YARA_MATCHES" >> $GITHUB_OUTPUT
          echo "yara-high-severity=$YARA_HIGH" >> $GITHUB_OUTPUT
        else
          echo "yara-matches=0" >> $GITHUB_OUTPUT
          echo "yara-high-severity=0" >> $GITHUB_OUTPUT
        fi

    - name: Upload YARA-matched files
      if: ${{ inputs.upload == 'true' && inputs.yara-scan == 'true' }}
      shell: bash
      env:
        UC_API_KEY: ${{ inputs.api-key }}
        UC_API_URL: ${{ inputs.api-url }}
        UC_REPO: ${{ inputs.repo }}
      run: |
        cd "${{ inputs.scan-path }}"
        node "${{ github.action_path }}/upload-yara-files.js" \
          --yara-results yara-results.json \
          --binary-results binary-scan-results.json \
          --scan-path .

    - name: Run License Checker
      id: license
      if: ${{ inputs.license-check == 'true' }}
      shell: bash
      env:
        SCAN_PATH: ${{ inputs.scan-path }}
        LICENSE_POLICY: ${{ inputs.license-policy }}
      run: |
        cd "${{ inputs.scan-path }}"
        
        POLICY_ARG=""
        if [ -n "$LICENSE_POLICY" ]; then
          POLICY_ARG="--policy $LICENSE_POLICY"
        fi
        
        # License checker currently only supports npm
        if [ -d "node_modules" ]; then
          node "${{ github.action_path }}/license-checker.js" \
            --path node_modules \
            --output license-results.json \
            --github-annotations \
            --github-summary \
            $POLICY_ARG || true
        fi
        
        if [ -f "license-results.json" ]; then
          LICENSE_ALLOWED=$(node -e "console.log(require('./license-results.json').allowed?.length || 0)")
          LICENSE_WARNING=$(node -e "console.log(require('./license-results.json').warning?.length || 0)")
          LICENSE_DENIED=$(node -e "console.log(require('./license-results.json').denied?.length || 0)")
          echo "license-allowed=$LICENSE_ALLOWED" >> $GITHUB_OUTPUT
          echo "license-warning=$LICENSE_WARNING" >> $GITHUB_OUTPUT
          echo "license-denied=$LICENSE_DENIED" >> $GITHUB_OUTPUT
        else
          echo "license-allowed=0" >> $GITHUB_OUTPUT
          echo "license-warning=0" >> $GITHUB_OUTPUT
          echo "license-denied=0" >> $GITHUB_OUTPUT
        fi

    - name: Upload Results Artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: binary-scan-results
        path: |
          ${{ inputs.scan-path }}/binary-scan-results.json
          ${{ inputs.scan-path }}/yara-results.json
          ${{ inputs.scan-path }}/license-results.json
        retention-days: 30
        overwrite: true

    - name: Generate Summary Report
      if: ${{ always() && inputs.generate-summary == 'true' }}
      shell: bash
      run: |
        cd "${{ inputs.scan-path }}"
        node "${{ github.action_path }}/generate-summary.js"

    - name: Fail on Threats
      if: ${{ inputs.fail-on-threats == 'true' }}
      shell: bash
      run: |
        THREATS="${{ steps.scan.outputs.threats-found }}"
        YARA_HIGH="${{ steps.yara.outputs.yara-high-severity }}"
        
        if [ "$THREATS" != "0" ] && [ -n "$THREATS" ]; then
          echo "::error::Security threats detected: $THREATS files with HIGH or MEDIUM threat level"
          exit 1
        fi
        
        if [ "$YARA_HIGH" != "0" ] && [ -n "$YARA_HIGH" ]; then
          echo "::error::YARA high-severity matches found: $YARA_HIGH"
          exit 1
        fi
        
        echo "No blocking threats detected"

    - name: Fail on License Issues
      if: ${{ inputs.fail-on-license == 'true' }}
      shell: bash
      run: |
        LICENSE_DENIED="${{ steps.license.outputs.license-denied }}"
        
        if [ "$LICENSE_DENIED" != "0" ] && [ -n "$LICENSE_DENIED" ]; then
          echo "::error::License compliance failed: $LICENSE_DENIED packages with denied licenses"
          exit 1
        fi
        
        echo "No license compliance issues"
