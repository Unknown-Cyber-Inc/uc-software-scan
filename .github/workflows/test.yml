# Test workflow for the package-binary-scanner action
name: Test Action

on:
  push:
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  # ==========================================================================
  # ECOSYSTEM DETECTION TESTS
  # Test that each ecosystem is properly detected and files are accessible
  # ==========================================================================
  
  test-npm-ecosystem:
    name: Test NPM Ecosystem
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create npm test project
        run: |
          mkdir -p test-project
          cd test-project
          npm init -y
          npm install esbuild --save-dev

      - name: Run Scanner (auto-detect npm)
        uses: ./
        id: scan
        with:
          scan-path: 'test-project'
          deep-scan: 'true'

      - name: Verify npm detection
        run: |
          echo "=== NPM Ecosystem Test ==="
          echo "Ecosystems scanned: ${{ steps.scan.outputs.ecosystems-scanned }}"
          echo "Total packages: ${{ steps.scan.outputs.total-packages }}"
          echo "Total binaries: ${{ steps.scan.outputs.total-binaries }}"
          
          # Verify npm was detected
          if [[ "${{ steps.scan.outputs.ecosystems-scanned }}" != *"npm"* ]]; then
            echo "::error::NPM ecosystem was not detected"
            exit 1
          fi
          
          # Verify we found binaries (esbuild has native binaries)
          if [ "${{ steps.scan.outputs.total-binaries }}" -eq "0" ]; then
            echo "::error::No binaries found in npm packages"
            exit 1
          fi
          
          # Verify package attribution in JSON
          node -e "
            const r = require('./test-project/binary-scan-results.json');
            const hasEsbuild = r.packages.some(p => p.package.includes('esbuild'));
            if (!hasEsbuild) {
              console.error('esbuild package not found in results');
              process.exit(1);
            }
            console.log('✓ Package attribution working for npm');
          "

  test-pip-ecosystem:
    name: Test Python/pip Ecosystem
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Create pip test project
        run: |
          mkdir -p test-project
          cd test-project
          # Install packages with native extensions
          pip install numpy==1.26.0 --target=site-packages
          pip install pillow==10.0.0 --target=site-packages

      - name: Run Scanner (auto-detect pip)
        uses: ./
        id: scan
        with:
          scan-path: 'test-project'
          deep-scan: 'true'

      - name: Verify pip detection
        run: |
          echo "=== Python/pip Ecosystem Test ==="
          echo "Ecosystems scanned: ${{ steps.scan.outputs.ecosystems-scanned }}"
          echo "Total packages: ${{ steps.scan.outputs.total-packages }}"
          echo "Total binaries: ${{ steps.scan.outputs.total-binaries }}"
          
          # Verify pip was detected
          if [[ "${{ steps.scan.outputs.ecosystems-scanned }}" != *"pip"* ]]; then
            echo "::error::pip ecosystem was not detected"
            exit 1
          fi
          
          # Verify we found .so files (numpy has native extensions)
          if [ "${{ steps.scan.outputs.total-binaries }}" -eq "0" ]; then
            echo "::error::No binaries found in pip packages"
            exit 1
          fi
          
          # Verify package attribution
          node -e "
            const r = require('./test-project/binary-scan-results.json');
            const hasNumpy = r.packages.some(p => p.package.toLowerCase().includes('numpy'));
            if (!hasNumpy) {
              console.error('numpy package not found in results');
              process.exit(1);
            }
            // Check version was extracted
            const numpyPkg = r.packages.find(p => p.package.toLowerCase().includes('numpy'));
            if (numpyPkg && numpyPkg.version === 'unknown') {
              console.warn('Warning: numpy version not extracted');
            }
            console.log('✓ Package attribution working for pip');
          "

  test-maven-ecosystem:
    name: Test Maven Ecosystem
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create maven test project
        run: |
          mkdir -p test-project/lib/org/apache/commons/commons-lang3/3.12.0
          
          # Create a fake JAR file (ZIP with proper magic bytes)
          cd test-project/lib/org/apache/commons/commons-lang3/3.12.0
          echo "PK" > commons-lang3-3.12.0.jar  # ZIP magic bytes (simplified)
          printf '\x50\x4b\x03\x04' > commons-lang3-3.12.0.jar
          
          # Create pom.xml for metadata
          cat > pom.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <project>
            <groupId>org.apache.commons</groupId>
            <artifactId>commons-lang3</artifactId>
            <version>3.12.0</version>
          </project>
          EOF

      - name: Run Scanner (explicit maven)
        uses: ./
        id: scan
        with:
          scan-path: 'test-project'
          ecosystems: 'maven'
          deep-scan: 'true'

      - name: Verify maven detection
        run: |
          echo "=== Maven Ecosystem Test ==="
          echo "Ecosystems scanned: ${{ steps.scan.outputs.ecosystems-scanned }}"
          echo "Total packages: ${{ steps.scan.outputs.total-packages }}"
          echo "Total binaries: ${{ steps.scan.outputs.total-binaries }}"
          
          cat test-project/binary-scan-results.json
          
          # Verify we found the JAR
          if [ "${{ steps.scan.outputs.total-binaries }}" -eq "0" ]; then
            echo "::error::No JAR files found in maven lib"
            exit 1
          fi

  test-cargo-ecosystem:
    name: Test Cargo/Rust Ecosystem
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create cargo test project
        run: |
          mkdir -p test-project/target/release
          
          # Create Cargo.toml
          cat > test-project/Cargo.toml << 'EOF'
          [package]
          name = "test-rust-app"
          version = "0.1.0"
          edition = "2021"
          EOF
          
          # Create fake ELF binary
          printf '\x7fELF' > test-project/target/release/test-rust-app

      - name: Run Scanner (explicit cargo)
        uses: ./
        id: scan
        with:
          scan-path: 'test-project'
          ecosystems: 'cargo'
          deep-scan: 'true'

      - name: Verify cargo detection
        run: |
          echo "=== Cargo Ecosystem Test ==="
          echo "Ecosystems scanned: ${{ steps.scan.outputs.ecosystems-scanned }}"
          echo "Total packages: ${{ steps.scan.outputs.total-packages }}"
          echo "Total binaries: ${{ steps.scan.outputs.total-binaries }}"
          
          cat test-project/binary-scan-results.json

  test-go-ecosystem:
    name: Test Go Ecosystem
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create go test project
        run: |
          mkdir -p test-project/vendor/github.com/user/repo
          
          # Create go.mod
          cat > test-project/vendor/github.com/user/repo/go.mod << 'EOF'
          module github.com/user/repo
          go 1.21
          EOF
          
          # Create fake .so file
          printf '\x7fELF' > test-project/vendor/github.com/user/repo/helper.so

      - name: Run Scanner (explicit go)
        uses: ./
        id: scan
        with:
          scan-path: 'test-project'
          ecosystems: 'go'
          deep-scan: 'true'

      - name: Verify go detection
        run: |
          echo "=== Go Ecosystem Test ==="
          echo "Ecosystems scanned: ${{ steps.scan.outputs.ecosystems-scanned }}"
          echo "Total packages: ${{ steps.scan.outputs.total-packages }}"
          echo "Total binaries: ${{ steps.scan.outputs.total-binaries }}"
          
          cat test-project/binary-scan-results.json

  test-auto-detect-multiple:
    name: Test Auto-Detect Multiple Ecosystems
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Create multi-ecosystem project
        run: |
          mkdir -p test-project
          cd test-project
          
          # Create npm project
          npm init -y
          npm install esbuild --save-dev
          
          # Create pip packages
          pip install numpy==1.26.0 --target=site-packages

      - name: Run Scanner (auto-detect all)
        uses: ./
        id: scan
        with:
          scan-path: 'test-project'
          deep-scan: 'true'

      - name: Verify multiple ecosystems detected
        run: |
          echo "=== Multi-Ecosystem Auto-Detection Test ==="
          echo "Ecosystems scanned: ${{ steps.scan.outputs.ecosystems-scanned }}"
          echo "Total packages: ${{ steps.scan.outputs.total-packages }}"
          echo "Total binaries: ${{ steps.scan.outputs.total-binaries }}"
          
          # Verify both ecosystems were detected
          ECOSYSTEMS="${{ steps.scan.outputs.ecosystems-scanned }}"
          if [[ "$ECOSYSTEMS" != *"npm"* ]]; then
            echo "::error::npm ecosystem was not auto-detected"
            exit 1
          fi
          if [[ "$ECOSYSTEMS" != *"pip"* ]]; then
            echo "::error::pip ecosystem was not auto-detected"
            exit 1
          fi
          
          echo "✓ Both npm and pip ecosystems auto-detected"
          
          # Verify results contain packages from both ecosystems
          node -e "
            const r = require('./test-project/binary-scan-results.json');
            const ecosystems = [...new Set(r.packages.map(p => p.ecosystem))];
            console.log('Ecosystems in results:', ecosystems);
            if (!ecosystems.includes('npm')) {
              console.error('npm packages not in results');
              process.exit(1);
            }
            if (!ecosystems.includes('pip')) {
              console.error('pip packages not in results');
              process.exit(1);
            }
            console.log('✓ Results contain packages from both ecosystems');
          "

  # ==========================================================================
  # CLI TESTS
  # Test command line interface options
  # ==========================================================================

  test-cli-ecosystems:
    name: Test CLI Ecosystem Options
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create test project
        run: |
          mkdir -p test-project/node_modules/test-pkg
          echo '{"name":"test-pkg","version":"1.0.0"}' > test-project/node_modules/test-pkg/package.json
          printf '\x7fELF' > test-project/node_modules/test-pkg/binary

      - name: Test --list-ecosystems
        run: |
          node scanner.js --list-ecosystems
          echo "✓ --list-ecosystems works"

      - name: Test --ecosystem option
        run: |
          node scanner.js --ecosystem npm test-project
          echo "✓ --ecosystem npm works"

      - name: Test -e shorthand
        run: |
          node scanner.js -e npm test-project
          echo "✓ -e shorthand works"

      - name: Test auto-detection (no --ecosystem)
        run: |
          node scanner.js test-project
          echo "✓ Auto-detection works"

      - name: Test --help includes ecosystem info
        run: |
          node scanner.js --help | grep -i ecosystem
          echo "✓ Help includes ecosystem info"

  # ==========================================================================
  # UPLOAD TESTS (npm only - tests common upload code)
  # ==========================================================================

  test-with-upload:
    name: Test With Upload (Smart Deduplication)
    runs-on: ubuntu-latest
    needs: [test-npm-ecosystem, test-pip-ecosystem]
    if: ${{ github.event_name == 'push' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create test project
        run: |
          mkdir -p test-project
          cd test-project
          npm init -y
          npm install esbuild --save-dev

      - name: Run Binary Scanner (with upload)
        uses: ./
        id: scan
        with:
          scan-path: 'test-project'
          deep-scan: 'true'
          upload: 'true'
          api-key: ${{ secrets.UC_API_KEY }}

      - name: Check results
        run: |
          echo "=== Scan Results ==="
          echo "Ecosystems: ${{ steps.scan.outputs.ecosystems-scanned }}"
          echo "Total packages: ${{ steps.scan.outputs.total-packages }}"
          echo "Total binaries: ${{ steps.scan.outputs.total-binaries }}"
          echo ""
          echo "=== Upload Results ==="
          echo "Uploaded: ${{ steps.scan.outputs.upload-successful }}"
          echo "Failed: ${{ steps.scan.outputs.upload-failed }}"
          echo "Skipped: ${{ steps.scan.outputs.upload-skipped }}"
          echo ""
          echo "=== Threat Assessment ==="
          echo "Threats (HIGH/MEDIUM): ${{ steps.scan.outputs.threats-found }}"

      - name: Add to job summary
        run: |
          echo "## Binary Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Ecosystems | ${{ steps.scan.outputs.ecosystems-scanned }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Packages with binaries | ${{ steps.scan.outputs.total-packages }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Total binary files | ${{ steps.scan.outputs.total-binaries }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Uploaded | ${{ steps.scan.outputs.upload-successful }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Skipped (existing) | ${{ steps.scan.outputs.upload-skipped }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Failed | ${{ steps.scan.outputs.upload-failed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ⚠️ Threats (HIGH/MEDIUM) | ${{ steps.scan.outputs.threats-found }} |" >> $GITHUB_STEP_SUMMARY

  # ==========================================================================
  # YARA TESTS
  # ==========================================================================

  test-yara-binaries:
    name: Test YARA on Binaries
    runs-on: ubuntu-latest
    needs: test-npm-ecosystem
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create test project
        run: |
          mkdir -p test-project
          cd test-project
          npm init -y
          npm install esbuild --save-dev

      - name: Run Scanner with YARA
        uses: ./
        id: scan
        with:
          scan-path: 'test-project'
          deep-scan: 'true'
          yara-scan: 'true'

      - name: Check YARA results
        run: |
          echo "=== YARA Results ==="
          echo "Files with matches: ${{ steps.scan.outputs.yara-matches }}"
          echo "High severity: ${{ steps.scan.outputs.yara-high-severity }}"
          
          if [ -f "test-project/yara-results.json" ]; then
            cat test-project/yara-results.json
          fi

  # ==========================================================================
  # FILE OPTIONS TESTS
  # ==========================================================================

  test-include-package-json:
    name: Test Include package.json
    runs-on: ubuntu-latest
    needs: test-npm-ecosystem
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create test project
        run: |
          mkdir -p test-project
          cd test-project
          npm init -y
          npm install esbuild lodash --save-dev

      - name: Run Scanner with package.json
        uses: ./
        id: scan
        with:
          scan-path: 'test-project'
          include-package-json: 'true'

      - name: Check results
        run: |
          METADATA=$(node -e "const r = require('./test-project/binary-scan-results.json'); console.log(r.totalMetadata || 0)")
          echo "Metadata files: $METADATA"
          
          if [ "$METADATA" -eq "0" ]; then
            echo "::error::Expected package.json files to be included"
            exit 1
          fi
          echo "✓ package.json files included"

  test-include-all-files:
    name: Test Include All Files
    runs-on: ubuntu-latest
    needs: test-include-package-json
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create test project
        run: |
          mkdir -p test-project
          cd test-project
          npm init -y
          npm install lodash --save

      - name: Run Scanner with all files
        uses: ./
        id: scan
        with:
          scan-path: 'test-project'
          include-all-files: 'true'

      - name: Check results
        run: |
          OTHER=$(node -e "const r = require('./test-project/binary-scan-results.json'); console.log(r.totalOther || 0)")
          echo "Other files: $OTHER"
          
          if [ "$OTHER" -eq "0" ]; then
            echo "::error::Expected other files (JS, etc) to be included"
            exit 1
          fi
          echo "✓ All files included"
