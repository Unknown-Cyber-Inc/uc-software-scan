# Test workflow for the package-binary-scanner action
name: Test Action

on:
  push:
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  # ==========================================================================
  # ECOSYSTEM DETECTION TESTS
  # Test that each ecosystem is properly detected and files are accessible
  # ==========================================================================
  
  test-npm-ecosystem:
    name: Test NPM Ecosystem
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create npm test project
        run: |
          mkdir -p test-project
          cd test-project
          npm init -y
          npm install esbuild --save-dev

      - name: Run Scanner (auto-detect npm)
        uses: ./
        id: scan
        with:
          scan-path: 'test-project'
          deep-scan: 'true'
          artifact-name: 'results-npm'

      - name: Verify npm detection
        run: |
          echo "=== NPM Ecosystem Test ==="
          echo "Ecosystems scanned: ${{ steps.scan.outputs.ecosystems-scanned }}"
          echo "Total packages: ${{ steps.scan.outputs.total-packages }}"
          echo "Total binaries: ${{ steps.scan.outputs.total-binaries }}"
          
          # Verify npm was detected
          if [[ "${{ steps.scan.outputs.ecosystems-scanned }}" != *"npm"* ]]; then
            echo "::error::NPM ecosystem was not detected"
            exit 1
          fi
          
          # Verify we found binaries (esbuild has native binaries)
          if [ "${{ steps.scan.outputs.total-binaries }}" -eq "0" ]; then
            echo "::error::No binaries found in npm packages"
            exit 1
          fi
          
          # Verify package attribution in JSON
          node -e "
            const r = require('./test-project/binary-scan-results.json');
            const hasEsbuild = r.packages.some(p => p.package.includes('esbuild'));
            if (!hasEsbuild) {
              console.error('esbuild package not found in results');
              process.exit(1);
            }
            console.log('✓ Package attribution working for npm');
          "

  test-pip-ecosystem:
    name: Test Python/pip Ecosystem
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Create pip test project
        run: |
          mkdir -p test-project
          cd test-project
          # Install packages with native extensions (cryptography always has .so files)
          pip install cryptography==41.0.0 --target=site-packages
          
          # Debug: show what was installed
          echo "=== Installed packages ==="
          ls -la site-packages/
          echo "=== Looking for .so files ==="
          find site-packages -name "*.so" -type f | head -20

      - name: Run Scanner (auto-detect pip)
        uses: ./
        id: scan
        with:
          scan-path: 'test-project'
          deep-scan: 'true'
          artifact-name: 'results-pip'

      - name: Verify pip detection
        run: |
          echo "=== Python/pip Ecosystem Test ==="
          echo "Ecosystems scanned: ${{ steps.scan.outputs.ecosystems-scanned }}"
          echo "Total packages: ${{ steps.scan.outputs.total-packages }}"
          echo "Total binaries: ${{ steps.scan.outputs.total-binaries }}"
          
          # Verify pip was detected
          if [[ "${{ steps.scan.outputs.ecosystems-scanned }}" != *"pip"* ]]; then
            echo "::error::pip ecosystem was not detected"
            exit 1
          fi
          
          # Verify we found .so files (cryptography has native extensions)
          if [ "${{ steps.scan.outputs.total-binaries }}" -eq "0" ]; then
            echo "::error::No binaries found in pip packages"
            exit 1
          fi
          
          # Verify package attribution
          node -e "
            const r = require('./test-project/binary-scan-results.json');
            const hasCrypto = r.packages.some(p => p.package.toLowerCase().includes('cryptography') || p.package.toLowerCase().includes('cffi'));
            if (!hasCrypto) {
              console.error('cryptography/cffi package not found in results');
              console.log('Packages found:', r.packages.map(p => p.package));
              process.exit(1);
            }
            console.log('✓ Package attribution working for pip');
          "

  test-maven-ecosystem:
    name: Test Maven Ecosystem
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          # Don't use cache - we create pom.xml dynamically

      - name: Create maven test project
        run: |
          mkdir -p test-project
          cd test-project
          
          # Create minimal pom.xml with a dependency that has native code
          cat > pom.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <project xmlns="http://maven.apache.org/POM/4.0.0">
            <modelVersion>4.0.0</modelVersion>
            <groupId>com.test</groupId>
            <artifactId>test-app</artifactId>
            <version>1.0.0</version>
            <dependencies>
              <dependency>
                <groupId>org.xerial</groupId>
                <artifactId>sqlite-jdbc</artifactId>
                <version>3.42.0.0</version>
              </dependency>
            </dependencies>
          </project>
          EOF
          
          # Download dependencies to lib/ folder
          mvn dependency:copy-dependencies -DoutputDirectory=lib -q

      - name: Run Scanner (auto-detect maven)
        uses: ./
        id: scan
        with:
          scan-path: 'test-project'
          deep-scan: 'true'
          artifact-name: 'results-maven'

      - name: Verify maven detection
        run: |
          echo "=== Maven Ecosystem Test ==="
          echo "Ecosystems scanned: ${{ steps.scan.outputs.ecosystems-scanned }}"
          echo "Total packages: ${{ steps.scan.outputs.total-packages }}"
          echo "Total binaries: ${{ steps.scan.outputs.total-binaries }}"
          
          # sqlite-jdbc includes native .so/.dll files inside the JAR
          if [ "${{ steps.scan.outputs.total-binaries }}" -eq "0" ]; then
            echo "::error::No JAR files found"
            exit 1
          fi
          
          cat test-project/binary-scan-results.json

  test-cargo-ecosystem:
    name: Test Cargo/Rust Ecosystem
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: test-project

      - name: Create cargo test project
        run: |
          mkdir -p test-project
          cd test-project
          
          # Create Cargo.toml with a minimal binary
          cat > Cargo.toml << 'EOF'
          [package]
          name = "test-rust-app"
          version = "0.1.0"
          edition = "2021"
          EOF
          
          # Create minimal main.rs
          mkdir -p src
          echo 'fn main() { println!("Hello"); }' > src/main.rs
          
          # Build release binary
          cargo build --release

      - name: Run Scanner (auto-detect cargo)
        uses: ./
        id: scan
        with:
          scan-path: 'test-project'
          deep-scan: 'true'
          artifact-name: 'results-cargo'

      - name: Verify cargo detection
        run: |
          echo "=== Cargo Ecosystem Test ==="
          echo "Ecosystems scanned: ${{ steps.scan.outputs.ecosystems-scanned }}"
          echo "Total packages: ${{ steps.scan.outputs.total-packages }}"
          echo "Total binaries: ${{ steps.scan.outputs.total-binaries }}"
          
          # Should find the compiled binary
          if [ "${{ steps.scan.outputs.total-binaries }}" -eq "0" ]; then
            echo "::error::No binaries found in cargo target/release"
            exit 1
          fi
          
          cat test-project/binary-scan-results.json

  test-go-ecosystem:
    name: Test Go Ecosystem
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: false  # We'll manage our own project

      - name: Create go test project
        run: |
          mkdir -p test-project
          cd test-project
          
          # Create go.mod
          cat > go.mod << 'EOF'
          module test-go-app
          go 1.21
          require github.com/mattn/go-sqlite3 v1.14.17
          EOF
          
          # Create minimal main.go that imports the C-binding package
          cat > main.go << 'EOF'
          package main
          import _ "github.com/mattn/go-sqlite3"
          func main() {}
          EOF
          
          # Vendor dependencies (go-sqlite3 has CGO bindings)
          go mod tidy
          go mod vendor

      - name: Run Scanner (auto-detect go)
        uses: ./
        id: scan
        with:
          scan-path: 'test-project'
          deep-scan: 'true'
          artifact-name: 'results-go'

      - name: Verify go detection
        run: |
          echo "=== Go Ecosystem Test ==="
          echo "Ecosystems scanned: ${{ steps.scan.outputs.ecosystems-scanned }}"
          echo "Total packages: ${{ steps.scan.outputs.total-packages }}"
          echo "Total binaries: ${{ steps.scan.outputs.total-binaries }}"
          
          # go-sqlite3 vendors C source files
          cat test-project/binary-scan-results.json

  test-auto-detect-multiple:
    name: Test Auto-Detect Multiple Ecosystems
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Create multi-ecosystem project
        run: |
          mkdir -p test-project
          cd test-project
          
          # Create npm project
          npm init -y
          npm install esbuild --save-dev
          
          # Create pip packages
          pip install numpy==1.26.0 --target=site-packages

      - name: Run Scanner (auto-detect all)
        uses: ./
        id: scan
        with:
          scan-path: 'test-project'
          deep-scan: 'true'
          artifact-name: 'results-auto-detect'

      - name: Verify multiple ecosystems detected
        run: |
          echo "=== Multi-Ecosystem Auto-Detection Test ==="
          echo "Ecosystems scanned: ${{ steps.scan.outputs.ecosystems-scanned }}"
          echo "Total packages: ${{ steps.scan.outputs.total-packages }}"
          echo "Total binaries: ${{ steps.scan.outputs.total-binaries }}"
          
          # Verify both ecosystems were detected
          ECOSYSTEMS="${{ steps.scan.outputs.ecosystems-scanned }}"
          if [[ "$ECOSYSTEMS" != *"npm"* ]]; then
            echo "::error::npm ecosystem was not auto-detected"
            exit 1
          fi
          if [[ "$ECOSYSTEMS" != *"pip"* ]]; then
            echo "::error::pip ecosystem was not auto-detected"
            exit 1
          fi
          
          echo "✓ Both npm and pip ecosystems auto-detected"
          
          # Verify results contain packages from both ecosystems
          node -e "
            const r = require('./test-project/binary-scan-results.json');
            const ecosystems = [...new Set(r.packages.map(p => p.ecosystem))];
            console.log('Ecosystems in results:', ecosystems);
            if (!ecosystems.includes('npm')) {
              console.error('npm packages not in results');
              process.exit(1);
            }
            if (!ecosystems.includes('pip')) {
              console.error('pip packages not in results');
              process.exit(1);
            }
            console.log('✓ Results contain packages from both ecosystems');
          "

  # ==========================================================================
  # CLI TESTS
  # Test command line interface options
  # ==========================================================================

  test-cli-ecosystems:
    name: Test CLI Ecosystem Options
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create test project
        run: |
          mkdir -p test-project/node_modules/test-pkg
          echo '{"name":"test-pkg","version":"1.0.0"}' > test-project/node_modules/test-pkg/package.json
          printf '\x7fELF' > test-project/node_modules/test-pkg/binary

      - name: Test --list-ecosystems
        run: |
          node scanner.js --list-ecosystems
          echo "✓ --list-ecosystems works"

      - name: Test --ecosystem option
        run: |
          node scanner.js --ecosystem npm test-project
          echo "✓ --ecosystem npm works"

      - name: Test -e shorthand
        run: |
          node scanner.js -e npm test-project
          echo "✓ -e shorthand works"

      - name: Test auto-detection (no --ecosystem)
        run: |
          node scanner.js test-project
          echo "✓ Auto-detection works"

      - name: Test --help includes ecosystem info
        run: |
          node scanner.js --help | grep -i ecosystem
          echo "✓ Help includes ecosystem info"

  # ==========================================================================
  # UPLOAD TESTS (npm only - tests common upload code)
  # ==========================================================================

  test-with-upload:
    name: Test With Upload (Smart Deduplication)
    runs-on: ubuntu-latest
    needs: [test-npm-ecosystem, test-pip-ecosystem]
    if: ${{ github.event_name == 'push' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create test project
        run: |
          mkdir -p test-project
          cd test-project
          npm init -y
          npm install esbuild --save-dev

      - name: Run Binary Scanner (with upload)
        uses: ./
        id: scan
        with:
          scan-path: 'test-project'
          deep-scan: 'true'
          upload: 'true'
          api-key: ${{ secrets.UC_API_KEY }}
          artifact-name: 'results-upload'

      - name: Check results
        run: |
          echo "=== Scan Results ==="
          echo "Ecosystems: ${{ steps.scan.outputs.ecosystems-scanned }}"
          echo "Total packages: ${{ steps.scan.outputs.total-packages }}"
          echo "Total binaries: ${{ steps.scan.outputs.total-binaries }}"
          echo ""
          echo "=== Upload Results ==="
          echo "Uploaded: ${{ steps.scan.outputs.upload-successful }}"
          echo "Failed: ${{ steps.scan.outputs.upload-failed }}"
          echo "Skipped: ${{ steps.scan.outputs.upload-skipped }}"
          echo ""
          echo "=== Threat Assessment ==="
          echo "Threats (HIGH/MEDIUM): ${{ steps.scan.outputs.threats-found }}"

      - name: Add to job summary
        run: |
          echo "## Binary Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Ecosystems | ${{ steps.scan.outputs.ecosystems-scanned }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Packages with binaries | ${{ steps.scan.outputs.total-packages }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Total binary files | ${{ steps.scan.outputs.total-binaries }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Uploaded | ${{ steps.scan.outputs.upload-successful }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Skipped (existing) | ${{ steps.scan.outputs.upload-skipped }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Failed | ${{ steps.scan.outputs.upload-failed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ⚠️ Threats (HIGH/MEDIUM) | ${{ steps.scan.outputs.threats-found }} |" >> $GITHUB_STEP_SUMMARY

  # ==========================================================================
  # MALWARE DETECTION TESTS
  # Verify the scanner correctly detects injected malware samples
  # Test PASSES if malware is detected, FAILS if it's missed
  # ==========================================================================

  test-malware-detection:
    name: Test Malware Detection
    runs-on: ubuntu-latest
    needs: test-npm-ecosystem
    if: ${{ github.event_name == 'push' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create test project with npm
        run: |
          mkdir -p test-project
          cd test-project
          npm init -y
          npm install lodash --save

      - name: Inject malware samples
        uses: ./malware-test-inject
        id: inject
        with:
          api-key: ${{ secrets.UC_API_KEY }}
          ecosystem: npm
          package-name: malicious-package
          samples: obfuscated-js,elf-malware
          target-path: test-project

      - name: Check injection results
        id: check-injection
        run: |
          echo "Injected to: ${{ steps.inject.outputs.injected-path }}"
          echo "Sample count: ${{ steps.inject.outputs.samples-count }}"
          echo "Files: ${{ steps.inject.outputs.sample-files }}"
          
          SAMPLE_COUNT="${{ steps.inject.outputs.samples-count }}"
          if [ -z "$SAMPLE_COUNT" ] || [ "$SAMPLE_COUNT" -eq "0" ]; then
            echo "::warning::No malware samples were injected - API key may be missing or download failed"
            echo "samples-available=false" >> $GITHUB_OUTPUT
          else
            echo "samples-available=true" >> $GITHUB_OUTPUT
            # Verify files exist at the injected path
            ls -la "${{ steps.inject.outputs.injected-path }}/" || true
          fi

      - name: Run Scanner with YARA and upload
        if: steps.check-injection.outputs.samples-available == 'true'
        uses: ./
        id: scan
        with:
          scan-path: 'test-project'
          deep-scan: 'true'
          upload: 'true'
          yara-scan: 'true'
          yara-include: '*.js,*.elf'
          generate-summary: 'true'
          api-key: ${{ secrets.UC_API_KEY }}
          artifact-name: 'results-malware-detection'

      - name: Verify malware was detected
        if: steps.check-injection.outputs.samples-available == 'true'
        run: |
          echo "=== Malware Detection Test ==="
          echo "YARA matches: ${{ steps.scan.outputs.yara-matches }}"
          echo "YARA high severity: ${{ steps.scan.outputs.yara-high-severity }}"
          echo "Threats found: ${{ steps.scan.outputs.threats-found }}"
          
          # Check YARA detected the malware
          if [ "${{ steps.scan.outputs.yara-matches }}" -eq "0" ]; then
            echo "::error::YARA did not detect any matches - malware detection FAILED"
            cat test-project/yara-results.json 2>/dev/null || echo "No YARA results file"
            exit 1
          fi
          
          echo "✓ YARA detected ${{ steps.scan.outputs.yara-matches }} suspicious files"
          
          # Show what was detected
          if [ -f "test-project/yara-results.json" ]; then
            echo ""
            echo "=== YARA Detections ==="
            node -e "
              const y = require('./test-project/yara-results.json');
              y.matches.forEach(m => {
                console.log('File:', m.file);
                console.log('Rules:', m.rules.map(r => r.rule).join(', '));
                console.log('Severity:', m.highestSeverity);
                console.log('---');
              });
            "
          fi
          
          echo ""
          echo "✓ Malware detection test PASSED - injected samples were correctly detected"

      - name: Skip message (no samples)
        if: steps.check-injection.outputs.samples-available != 'true'
        run: |
          echo "::warning::Malware detection test SKIPPED - no samples were injected"
          echo "This may be due to missing UC_API_KEY secret or API download failure."
          echo "The malware-test-inject action requires a valid UnknownCyber API key."

  # ==========================================================================
  # YARA TESTS
  # ==========================================================================

  test-yara-binaries:
    name: Test YARA on Binaries
    runs-on: ubuntu-latest
    needs: test-npm-ecosystem
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create test project
        run: |
          mkdir -p test-project
          cd test-project
          npm init -y
          npm install esbuild --save-dev

      - name: Run Scanner with YARA
        uses: ./
        id: scan
        with:
          scan-path: 'test-project'
          deep-scan: 'true'
          yara-scan: 'true'
          artifact-name: 'results-yara'

      - name: Check YARA results
        run: |
          echo "=== YARA Results ==="
          echo "Files with matches: ${{ steps.scan.outputs.yara-matches }}"
          echo "High severity: ${{ steps.scan.outputs.yara-high-severity }}"
          
          if [ -f "test-project/yara-results.json" ]; then
            cat test-project/yara-results.json
          fi

  # ==========================================================================
  # FILE OPTIONS TESTS
  # ==========================================================================

  test-include-package-json:
    name: Test Include package.json
    runs-on: ubuntu-latest
    needs: test-npm-ecosystem
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create test project
        run: |
          mkdir -p test-project
          cd test-project
          npm init -y
          npm install esbuild lodash --save-dev

      - name: Run Scanner with package.json
        uses: ./
        id: scan
        with:
          scan-path: 'test-project'
          include-package-json: 'true'
          artifact-name: 'results-package-json'

      - name: Check results
        run: |
          METADATA=$(node -e "const r = require('./test-project/binary-scan-results.json'); console.log(r.totalMetadata || 0)")
          echo "Metadata files: $METADATA"
          
          if [ "$METADATA" -eq "0" ]; then
            echo "::error::Expected package.json files to be included"
            exit 1
          fi
          echo "✓ package.json files included"

  test-include-all-files:
    name: Test Include All Files
    runs-on: ubuntu-latest
    needs: test-include-package-json
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create test project
        run: |
          mkdir -p test-project
          cd test-project
          npm init -y
          npm install lodash --save

      - name: Run Scanner with all files
        uses: ./
        id: scan
        with:
          scan-path: 'test-project'
          include-all-files: 'true'
          artifact-name: 'results-all-files'

      - name: Check results
        run: |
          OTHER=$(node -e "const r = require('./test-project/binary-scan-results.json'); console.log(r.totalOther || 0)")
          echo "Other files: $OTHER"
          
          if [ "$OTHER" -eq "0" ]; then
            echo "::error::Expected other files (JS, etc) to be included"
            exit 1
          fi
          echo "✓ All files included"
